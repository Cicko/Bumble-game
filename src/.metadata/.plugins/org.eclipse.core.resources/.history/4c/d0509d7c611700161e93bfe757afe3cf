/**
 * @author Rudolf Cicko
 * @email alu0100824780@ull.edu.es
 * @description Shooter panel that contain balls and the gun that shoot more balls.
 * @subject Programaci√≥n de aplicaciones interactivas
 */
package es.ull.esit.pai.p12_disparos;

import java.applet.Applet;
import java.applet.AudioClip;
import java.awt.Color;
import java.awt.Graphics;
import java.awt.MediaTracker;
import java.awt.Point;
import java.awt.event.MouseEvent;
import java.awt.event.MouseListener;
import java.awt.event.MouseMotionListener;
import java.net.URL;
import java.util.ArrayList;
import java.util.Timer;
import java.util.TimerTask;

import javax.print.attribute.standard.Media;
import javax.swing.JPanel;

public class ShooterPanel extends JPanel implements MouseMotionListener, MouseListener {
	private final int SAME_COLOR = 1;
	private final int TIMER_DELAY = 10;         // miliseconds before the timer starts
	private final int TIMER_INTERVAL = 10;      // interval between frames
	private final int NEW_ROW_INTERVAL = 100;
	private final int Y_GUN_MARGIN = 10;
	private Timer timer = new Timer ();
	private Timer timer2 = new Timer ();
	private AudioClip soundGood;
	private AudioClip soundFail;
	private Gun gun;
	private Ball actualPreparedBall = null;            // the actual prepared ball to be shooted.
	private Ball shootedBall = null;
	private boolean canShoot;
	private ArrayList<Ball> balls;                     // All balls that are in the screen.
	private ArrayList<Ball> shootedBalls;
	private int numRows;
	
	public ShooterPanel () {
		numRows = 0;
		Point gunOrigin = new Point (300, 600 - Y_GUN_MARGIN); 
		gun = new Gun (gunOrigin, this);
		balls = new ArrayList<Ball> ();
		shootedBalls = new ArrayList<Ball> ();
		
		URL url = this.getClass().getResource("La.wav");
		URL url2 = this.getClass().getResource("EndGame.wav");	
		
		soundGood = Applet.newAudioClip(url);
		soundFail = Applet.newAudioClip(url2);
		
		timer.schedule(new TimerTask() {
			public void run () {	
				if (shootedBall != null) {
					repaint();
					//gun.paint();
					shootedBall.move();
					if (shootedBall.isCollided()) {
						canShoot = true;
						balls.add(shootedBall);
						shootedBall = null;
					}
				
					int counter = 0;
					for (int i = 0; i < balls.size(); i++) {
						balls.get(i).move();
						if (shootedBall != null && shootedBall.colliding(balls.get(i))) {
							shootedBall.setStatic();
							shootedBall.collided(balls.get(i));
							counter++;
						}
					}	
					if (counter == 1) 
						soundGood.play();
					else if (counter == 2) 
						soundFail.play();
				}
			}
		}, TIMER_DELAY, TIMER_INTERVAL);
		
		timer2.schedule (new TimerTask () {
			public void run () {
				createNewRow();
			}
		}, 1000, NEW_ROW_INTERVAL);
		
		canShoot = true;
	}
	
	
	public void createNewRow () {
		int numBalls = 600 / Ball.getSize();
		int xSeparation = 600 / numBalls;
		int yPos = Ball.getSize();
		System.out.println (numBalls + " " + xSeparation + " " + yPos); 
		for (int i = 0;i < numBalls-1; i++) {
			Point pos = new Point(xSeparation * i + Ball.getSize() / 2 + 1, yPos + Ball.getSize() / 2 + 1);
			balls.add(new Ball(pos, getRandomColor(), this, true));
		}
		for (int i = 0;i < balls.size() - numBalls + 1; i++) {
			balls.get(i).moveY(Ball.getSize());
		}
	}
	
	
	
	public Gun getGun () {
		return gun;
	}
	
	/**
	 * This method shot a ball from the gun with the specified angle
	 * @param angle is the angle used to shoot the ball.
	 */
	public void shoot () {
		if (canShoot) {
			canShoot = false;
			shootedBall = actualPreparedBall;
			actualPreparedBall = null;
			shootedBall.shoot (gun.getVector());
		}
	}
	
	
	public Color getRandomColor () {
		Color color = null;
		int candidate = (int) (Math.random() * 4.0);
		switch (candidate) {
		case 0:
			color = Color.red;
			break;
		case 1:
			color = Color.blue;
			break;
		case 2:
			color = Color.yellow;
			break;
		case 3:
			color = Color.green;
			break;
		}
		return color;
	}
	
	/**
	 * Main method for drawing things on the panel
	 */
	public void paintComponent (Graphics g) {
		super.paintComponent(g);
		gun.paint(g);
	}


	/**
	 * Method that is automatically invoked when the mouse is moved.
	 */
	@Override
	public void mouseMoved(MouseEvent e) {
		Point arrowHeadPos = gun.setMousePos (e.getPoint());
		repaint();
		
		paintAllBalls();
		if (actualPreparedBall == null) {
			actualPreparedBall = new Ball (arrowHeadPos, getRandomColor(), this, false);
		}
		else {
			actualPreparedBall.setPosition(arrowHeadPos);
		}
	}
	
	public void paintAllBalls () {
		for (int i = 0;i < balls.size(); i++) {
			balls.get(i).move();
		}
	}
	
	@Override
	public void mouseReleased(MouseEvent arg0) {
		shoot();
	}
	
    // NOT USED METHODS
	@Override
	public void mouseDragged(MouseEvent e) {
		// TODO Auto-generated method stub
		
	}

	
	@Override
	public void mouseClicked(MouseEvent arg0) {
		// TODO Auto-generated method stub
		
	}


	@Override
	public void mouseEntered(MouseEvent arg0) {
		// TODO Auto-generated method stub
		
	}


	@Override
	public void mouseExited(MouseEvent arg0) {
		// TODO Auto-generated method stub
		
	}


	@Override
	public void mousePressed(MouseEvent arg0) {
		// TODO Auto-generated method stub
		
	}

}
